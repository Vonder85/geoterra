---
import FormInput from "../form/FormInput.astro";
import FormSelect from "../form/FormSelect.astro";
import FormTextarea from "../form/FormTextarea.astro";
import FormCheckbox from "../form/FormCheckbox.astro";

// Options pour les selects
const serviceTypeOptions = [
  { value: "g1", label: "√âtude G1 - √âtude pr√©alable (achat terrain)" },
  {
    value: "g2-avp",
    label: "√âtude G2 AVP - Avant-projet (d√©finition fondations)",
  },
  {
    value: "g2-pro",
    label: "√âtude G2 PRO - Projet (dimensionnement fondations)",
  },
  { value: "g2-complete", label: "√âtude G2 compl√®te (AVP + PRO)" },
  {
    value: "g5",
    label: "Diagnostic G5 - En cas de d√©sordre/fissures/sur√©l√©vation",
  },
  { value: "g0", label: "Mission G0 - Investigation simplifi√©e" },
  { value: "conseil", label: "Conseil / Autre besoin" },
];

const projectTypeOptions = [
  { value: "maison-individuelle", label: "Maison individuelle" },
  { value: "petit-collectif", label: "Petit collectif (logements)" },
  { value: "extension", label: "Extension de b√¢timent existant" },
  { value: "piscine", label: "Piscine" },
  { value: "garage", label: "Garage / Annexe" },
  { value: "renovation", label: "R√©novation / Sur√©l√©vation" },
  { value: "autre", label: "Autre projet" },
];

const surfaceOptions = [
  { value: "moins-100", label: "Moins de 100 m¬≤" },
  { value: "100-150", label: "100 √† 150 m¬≤" },
  { value: "150-200", label: "150 √† 200 m¬≤" },
  { value: "200-300", label: "200 √† 300 m¬≤" },
  { value: "plus-300", label: "Plus de 300 m¬≤" },
  { value: "non-defini", label: "Non d√©fini" },
];

const timelineOptions = [
  { value: "urgent", label: "Urgent (sous 15 jours)" },
  { value: "1-mois", label: "Dans le mois" },
  { value: "2-3-mois", label: "Dans les 2-3 mois" },
  { value: "flexible", label: "Flexible" },
];
---

<div class='bg-white rounded-lg shadow-xl p-8'>
  <h2 class='text-2xl font-bold text-neutral-800 mb-6'>
    Demande de devis gratuit
  </h2>
  <p class='text-neutral-600 mb-8'>
    Remplissez ce formulaire et nous vous recontacterons sous 48h maximum pour
    √©tudier votre projet et vous proposer un devis personnalis√©.
  </p>

  <form id='contact-form' class='space-y-6'>
    <div class='grid grid-cols-1 md:grid-cols-2 gap-4'>
      <FormInput id='firstName' name='firstName' label='Pr√©nom' required />
      <FormInput id='lastName' name='lastName' label='Nom' required />
    </div>

    <div class='grid grid-cols-1 md:grid-cols-2 gap-4'>
      <FormInput type='email' id='email' name='email' label='Email' required />
      <FormInput
        type='tel'
        id='phone'
        name='phone'
        label='T√©l√©phone'
        required
      />
    </div>

    <div class='grid grid-cols-1 md:grid-cols-2 gap-4'>
      <FormSelect
        id='serviceType'
        name='serviceType'
        label="Type d'√©tude g√©otechnique"
        options={serviceTypeOptions}
        placeholder='S√©lectionnez votre besoin'
        required
      />
      <FormSelect
        id='projectType'
        name='projectType'
        label='Type de projet'
        options={projectTypeOptions}
        placeholder='S√©lectionnez un type'
        required
      />
    </div>

    <FormInput
      id='location'
      name='location'
      label='Localisation du projet'
      placeholder='Ville, d√©partement (Vend√©e 85 ou Loire-Atlantique 44)'
      required
    />

    <div class='grid grid-cols-1 md:grid-cols-2 gap-4'>
      <FormSelect
        id='surface'
        name='surface'
        label='Surface approximative du projet'
        options={surfaceOptions}
        placeholder='S√©lectionnez une surface'
      />
      <FormSelect
        id='timeline'
        name='timeline'
        label='√âch√©ances souhait√©es'
        options={timelineOptions}
        placeholder='S√©lectionnez une √©ch√©ance'
      />
    </div>

    <FormTextarea
      id='message'
      name='message'
      label='Description du projet et informations compl√©mentaires'
      placeholder='D√©crivez votre projet : type de construction, informations sur le terrain, contraintes particuli√®res, questions sp√©cifiques...'
      rows={5}
      required
    />

    <FormCheckbox
      id='consent'
      name='consent'
      label="J'accepte d'√™tre contact√© par GEOTERRA concernant ma demande d'informations."
      required
    />

    <div id='form-message' class='hidden p-4 rounded-lg'></div>

    <button
      type='submit'
      id='submit-button'
      class='w-full bg-accent-500 text-white py-4 px-8 rounded-lg font-semibold hover:bg-accent-600 focus:outline-none focus:ring-2 focus:ring-accent-500 focus:ring-offset-2 transition-colors shadow-lg disabled:opacity-50 disabled:cursor-not-allowed'
    >
      Envoyer ma demande de devis
    </button>

    <div class='text-center'>
      <p class='text-sm text-neutral-500'>
        üìû <strong>Vous pr√©f√©rez nous appeler ?</strong><br />
        <a
          href='tel:+33686082100'
          class='text-accent-600 hover:text-accent-700 font-medium'
          >06 86 08 21 00</a
        >
        {" "} | {""}
        <a
          href='tel:+33686156546'
          class='text-accent-600 hover:text-accent-700 font-medium'
          >06 86 15 65 46</a
        >
      </p>
    </div>
  </form>
</div>

<script>
  import emailjs from '@emailjs/browser';

  document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("contact-form");
    const submitButton = document.getElementById("submit-button");
    const formMessage = document.getElementById("form-message");

    if (!form) return;

    // Initialiser EmailJS avec la cl√© publique
    emailjs.init(import.meta.env.PUBLIC_EMAILJS_PUBLIC_KEY);

    form.addEventListener("submit", async function (e) {
      e.preventDefault();

      // D√©sactiver le bouton pendant l'envoi
      submitButton.disabled = true;
      submitButton.textContent = "Envoi en cours...";

      // Masquer les messages pr√©c√©dents
      formMessage.classList.add("hidden");

      try {
        // R√©cup√©rer les donn√©es du formulaire
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        // Pr√©parer les param√®tres pour EmailJS
        const templateParams = {
          subject: 'GEOTERRA - Demande de contact',
          prenom: data.firstName,
          nom: data.lastName,
          email: data.email,
          telephone: data.phone,
          type_etude: data.serviceType,
          type_projet: data.projectType,
          localisation: data.location,
          surface: data.surface || 'Non sp√©cifi√©',
          echeance: data.timeline || 'Non sp√©cifi√©',
          description: data.message,
        };

        // Envoyer via EmailJS
        await emailjs.send(
          import.meta.env.PUBLIC_EMAILJS_SERVICE_ID,
          'template_rxtqc5f',
          templateParams
        );

        // Afficher le message de succ√®s
        formMessage.textContent =
          "‚úÖ Votre demande a √©t√© envoy√©e avec succ√®s ! Nous vous recontacterons sous 48h.";
        formMessage.classList.remove("hidden", "bg-red-100", "text-red-700");
        formMessage.classList.add("bg-green-100", "text-green-700");

        // R√©initialiser le formulaire
        form.reset();
      } catch (error) {
        // Afficher le message d'erreur
        formMessage.textContent =
          "‚ùå Une erreur est survenue lors de l'envoi. Veuillez r√©essayer.";
        formMessage.classList.remove(
          "hidden",
          "bg-green-100",
          "text-green-700"
        );
        formMessage.classList.add("bg-red-100", "text-red-700");
        console.error("Erreur:", error);
      } finally {
        // R√©activer le bouton
        submitButton.disabled = false;
        submitButton.textContent = "Envoyer ma demande de devis";
      }
    });
  });
</script>
